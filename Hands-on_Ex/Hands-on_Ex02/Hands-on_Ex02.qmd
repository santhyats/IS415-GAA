---
title: "Thematic Mapping and Geographic Visualisation using R"
author: "Santhya Selvan"
date: "August 23, 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  freeze: true
---

## 2.1 Overview

In thematic mapping, map symbols are used to visualize selected properties of geographical features that are not visible. These properties include population, temperature, rainfall, vegetation distribution and such.

Geographic visualisation, or Geovisualisation, helps us to render a place, phenomenon or a process by providing us with the necessary graphical tools.

Choropleth maps are thematic maps that use colour mapping (pun intended) to represent statistical data, and are very commonly used in Geospatial Analytics. In this exercise, I plotted choropleth maps by using an R package called **tmap** package.

## 2.2 Preparation

The main package used is [**tmap**](https://cran.r-project.org/web/packages/tmap/) package in R. Beside **tmap**, four other R packages will be used.

They are:

-   [**readr**](https://readr.tidyverse.org/) for importing delimited text file,

-   [**tidyr**](https://tidyr.tidyverse.org/) for tidying data,

-   [**dplyr**](https://dplyr.tidyverse.org/) for wrangling data and

-   [**sf**](https://cran.r-project.org/web/packages/sf/index.html) for handling geospatial data.

Among the four packages, **readr**, **tidyr** and **dplyr** are part of **tidyverse** package. As such, we do not need to install them separately. Instead, just installing the tidyverse package will be sufficient.

<br>

```{r}
pacman::p_load(sf, tmap, tidyverse)
```

I used this code line above to load the needed packages into my Rstudio. Now we are ready to get started!

<br>

## 2.3 Importing the Data

### 2.3.1 The Data Sources

I will be using two data sets for the creation of my chloropleth map:

-   Master Plan 2014 Subzone Boundary (Web) (i.e. `MP14_SUBZONE_WEB_PL`) in ESRI shapefile format. It can be downloaded at [data.gov.sg](https://data.gov.sg/) This is a geospatial data. It consists of the geographical boundary of Singapore at the planning subzone level. The data is based on URA Master Plan 2014.

-   Singapore Residents by Planning Area / Subzone, Age Group, Sex and Type of Dwelling, June 2011-2020 in csv format (i.e. `respopagesextod2011to2020.csv`). This is an aspatial data fie. It can be downloaded at [Department of Statistics, Singapore](https://www.singstat.gov.sg/) Although it does not contain any coordinates values, but it’s PA and SZ fields can be used as unique identifiers to geocode to `MP14_SUBZONE_WEB_PL` shapefile.

### 2.3.1 Importing data to R

I used the *st_read()* function of **sf** package to import `MP14_SUBZONE_WEB_PL` shapefile into R as a simple feature data frame called `mpsz`. Below is the code:

```{r}
mpsz <- st_read(dsn="data/geospatial", 
                layer = "MP14_SUBZONE_WEB_PL")
```

<br>By typing the name of the variable `mpsz`, we will be able to view its contents, as seen below.

```{r}
mpsz
```

<br>Next, I will use the **read_csv()** function from the **readr** package to import the *respopagsex2011to2020.csv* file into R and save it as a data fram called *popdata*.

This is Illustrated below.

```{r}
popdata <- read_csv("data/aspatial/respopagesextod2011to2020.csv")
```

### **2.3.2 Preparing the data**

Before creating the thematic maps, I first created a data table with year 2020 values. The data table included the following variables: PA, SZ, YOUNG, ECONOMY ACTIVE, AGED, TOTAL, DEPENDENCY.

-   YOUNG: age group 0 to 4 until age group 20 to 24,

-   ECONOMY ACTIVE: age group 25-29 until age group 60-64,

-   AGED: age group 65 and above,

-   TOTAL: all age group, and

-   DEPENDENCY: the ratio between young and aged against economy active group

#### 2.3.2.1 Data wrangling

I used the *pivot_wider()* of **tidyr** package, and *mutate()*, *filter()*, *group_by()* and *select()* of the **dplyr** package.

```{r}
popdata2020 <- popdata %>%
  filter(Time == 2020) %>%
  group_by(PA, SZ, AG) %>%
  summarise(`POP` = sum(`Pop`)) %>%
  ungroup()%>%
  pivot_wider(names_from=AG, 
              values_from=POP) %>%
  mutate(YOUNG = rowSums(.[3:6])
         +rowSums(.[12])) %>%
mutate(`ECONOMY ACTIVE` = rowSums(.[7:11])+
rowSums(.[13:15]))%>%
mutate(`AGED`=rowSums(.[16:21])) %>%
mutate(`TOTAL`=rowSums(.[3:21])) %>%  
mutate(`DEPENDENCY` = (`YOUNG` + `AGED`)
/`ECONOMY ACTIVE`) %>%
  select(`PA`, `SZ`, `YOUNG`, 
       `ECONOMY ACTIVE`, `AGED`, 
       `TOTAL`, `DEPENDENCY`)

```

#### 2.3.2.2 Joining the geospatial and aspatial data

The values in PA and SZ fields need to be converted to uppercase. This is because the values of PA and SZ fields are made up of both upper- and lowercase values. On the other, hand the SUBZONE_N and PLN_AREA_N are in uppercase. This will help standardise the values across the table.

```{r}
popdata2020 <- popdata2020 %>%
  mutate_at(.vars = vars(PA, SZ), 
          .funs = list(toupper)) %>%
  filter(`ECONOMY ACTIVE` > 0)
```

I then used *left_join()* of **dplyr** to join the geographical data and attribute table using planning subzone name as the common identifier.

```{r}
mpsz_pop2020 <- left_join(mpsz, popdata2020,
                          by = c("SUBZONE_N" = "SZ"))
```

## 2.4 Choropleth Mapping using tmap 

And finally to the \*highlight\* of the exercise: the actual mapping! Here, I covered two approaches to to preparing a thematic map using tmap. They are:

-   Plotting a thematic map using *qtm()*. This is the faster method.

-   Plotting highly customisable thematic map by using tmap elements.

Let's dive into these methods. <br>

### 2.4.1 Using qtm() 

qtm() provides a good default visualisation.

```{r}
tmap_mode("plot")
qtm(mpsz_pop2020, 
    fill = "DEPENDENCY")
```

<br>

### **2.4.2 Creating a choropleth map by using *tmap*’s elements**

Despite its usefulness of drawing a choropleth map quickly and easily, the disadvantge of *qtm()* is that it makes aesthetics of individual layers harder to control. tmap's drawing elements can be used to draw a high quality cartographic choropleth map.

```{r}
tm_shape(mpsz_pop2020)+
  tm_fill("DEPENDENCY", 
          style = "quantile", 
          palette = "Blues",
          title = "Dependency ratio") +
  tm_layout(main.title = "Distribution of Dependency Ratio by planning subzone",
            main.title.position = "center",
            main.title.size = 1.2,
            legend.height = 0.45, 
            legend.width = 0.35,
            frame = TRUE) +
  tm_borders(alpha = 0.5) +
  tm_compass(type="8star", size = 2) +
  tm_scale_bar() +
  tm_grid(alpha =0.2) +
  tm_credits("Source: Planning Sub-zone boundary from Urban Redevelopment Authorithy (URA)\n and Population data from Department of Statistics DOS", 
             position = c("left", "bottom"))
```

<br>
